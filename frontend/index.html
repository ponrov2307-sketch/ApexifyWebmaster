<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Apex Wealth Master Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        basebg: '#0B0E14',
                        headerbg: '#11141C',
                        cardbg: '#1C1C1E',
                        accent: '#D0FD3E',
                        success: '#32D74B',
                        danger: '#FF453A',
                        textmain: '#FFFFFF',
                        textsub: '#8E8E93'
                    }
                }
            }
        }
    </script>
    <style>
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #0B0E14; }
        ::-webkit-scrollbar-thumb { background: #1C1C1E; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #D0FD3E; }
        .modal { display: none; }
        .modal.active { display: flex; }
    </style>
</head>
<body class="bg-basebg text-textmain font-sans min-h-screen">

    <nav class="bg-headerbg border-b border-gray-800 p-4 sticky top-0 z-10 shadow-lg">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <i class="fa-solid fa-chart-line text-accent text-2xl"></i>
                <h1 class="text-xl font-bold tracking-wider">APEX <span class="text-accent">WEALTH</span></h1>
            </div>
            <button onclick="openModal()" class="bg-accent text-basebg font-bold px-4 py-2 rounded-lg hover:opacity-80 transition flex items-center">
                <i class="fa-solid fa-plus mr-2"></i> Add Asset
            </button>
        </div>
    </nav>

    <div id="error-banner" class="hidden bg-danger text-white text-center py-2 font-bold animate-pulse">
        <i class="fa-solid fa-triangle-exclamation"></i> ไม่สามารถเชื่อมต่อ Backend ได้ กรุณารันคำสั่ง 'uvicorn main:app --reload' ที่ฝั่ง Backend
    </div>

    <div class="max-w-7xl mx-auto p-4 md:p-8">
        <div class="bg-headerbg p-6 rounded-2xl mb-8 border border-gray-800 flex flex-col md:flex-row justify-between items-center shadow-lg">
            <div>
                <p class="text-textsub uppercase tracking-wider text-sm mb-1">Total Net Worth (USD)</p>
                <h2 class="text-5xl font-bold text-accent" id="net-worth">$0.00</h2>
            </div>
            <div class="mt-4 md:mt-0 bg-basebg p-4 rounded-xl border border-gray-800 min-w-[200px] text-right">
                <p class="text-textsub text-sm">Profit / Loss</p>
                <h3 class="text-2xl font-bold mt-1" id="total-profit">$0.00 (0.00%)</h3>
            </div>
        </div>

        <div class="flex space-x-3 mb-6 border-b border-gray-800 pb-2">
            <button onclick="filterGroup('ALL')" id="tab-ALL" class="px-6 py-2 rounded-full font-semibold border transition bg-accent text-basebg border-accent">ภาพรวม (All)</button>
            <button onclick="filterGroup('DCA')" id="tab-DCA" class="px-6 py-2 rounded-full text-textsub hover:text-white border border-transparent transition">เติบโต (DCA)</button>
            <button onclick="filterGroup('DIV')" id="tab-DIV" class="px-6 py-2 rounded-full text-textsub hover:text-white border border-transparent transition">ปันผล (DIV)</button>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4" id="asset-container">
            <div class="text-textsub">กำลังโหลดข้อมูล...</div>
        </div>
    </div>

    <div id="asset-modal" class="modal fixed inset-0 bg-black bg-opacity-80 z-50 justify-center items-center p-4">
        <div class="bg-headerbg border border-gray-700 p-6 rounded-2xl w-full max-w-md">
            <h3 class="text-2xl font-bold mb-4 text-white" id="modal-title">จัดการรายการหุ้น</h3>
            <div class="space-y-4">
                <input type="text" id="inp-ticker" class="w-full bg-cardbg border border-gray-600 rounded p-3 text-white uppercase focus:border-accent outline-none" placeholder="ชื่อย่อหุ้น (Ticker)">
                <div class="flex space-x-4">
                    <input type="number" id="inp-shares" class="w-1/2 bg-cardbg border border-gray-600 rounded p-3 text-white focus:border-accent outline-none" placeholder="จำนวนหุ้น">
                    <input type="number" id="inp-cost" class="w-1/2 bg-cardbg border border-gray-600 rounded p-3 text-white focus:border-accent outline-none" placeholder="ราคาทุนเฉลี่ย">
                </div>
                <div class="flex space-x-4">
                    <div class="w-1/2 relative">
                        <span class="absolute top-1 left-2 text-[10px] text-accent">แจ้งเตือน Bot</span>
                        <input type="number" id="inp-alert" class="w-full bg-cardbg border border-gray-600 rounded p-3 pt-5 text-white focus:border-accent outline-none" placeholder="Alert Price">
                    </div>
                    <select id="inp-group" class="w-1/2 bg-cardbg border border-gray-600 rounded p-3 text-white focus:border-accent outline-none">
                        <option value="Auto">Auto</option><option value="DCA">DCA</option><option value="DIV">DIV</option>
                    </select>
                </div>
            </div>
            <div class="mt-6 flex justify-between">
                <button onclick="deleteAsset()" id="btn-delete" class="bg-danger text-white px-4 py-2 rounded font-bold hover:bg-red-600 hidden">ลบรายการ</button>
                <div class="flex space-x-2 w-full justify-end">
                    <button onclick="closeModal()" class="bg-gray-700 text-white px-4 py-2 rounded font-bold hover:bg-gray-600">ยกเลิก</button>
                    <button onclick="saveAsset()" class="bg-accent text-basebg px-6 py-2 rounded font-bold hover:opacity-80">บันทึก</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let globalAssets = [];
        let currentGroup = 'ALL';

        function formatMoney(val) { return val.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2}); }

        async function fetchDashboard() {
            try {
                const res = await fetch('http://localhost:8000/api/dashboard');
                if(!res.ok) throw new Error("Network Error");
                const data = await res.json();
                
                document.getElementById('error-banner').classList.add('hidden');
                document.getElementById('net-worth').innerText = `$${formatMoney(data.summary.net_worth)}`;
                
                const profitEl = document.getElementById('total-profit');
                const isProfit = data.summary.total_profit >= 0;
                profitEl.className = `text-2xl font-bold mt-1 ${isProfit ? 'text-success' : 'text-danger'}`;
                profitEl.innerText = `${isProfit ? '+' : ''}$${formatMoney(data.summary.total_profit)} (${isProfit ? '+' : ''}${data.summary.total_profit_pct.toFixed(2)}%)`;

                globalAssets = data.assets;
                renderAssets();
            } catch (err) {
                document.getElementById('error-banner').classList.remove('hidden');
            }
        }

        function renderAssets() {
            const container = document.getElementById('asset-container');
            container.innerHTML = '';
            
            const filtered = globalAssets.filter(a => currentGroup === 'ALL' || a.group === currentGroup);
            
            filtered.forEach(asset => {
                const isProfit = asset.profit >= 0;
                const sign = isProfit ? '+' : '';
                const card = `
                    <div onclick='openModal(${JSON.stringify(asset).replace(/'/g, "\\'")})' class="bg-cardbg p-5 rounded-xl border border-gray-800 hover:border-accent cursor-pointer transition relative group">
                        ${asset.alert_price > 0 ? `<div class="absolute top-3 right-3 text-xs bg-gray-800 text-gray-400 px-2 py-1 rounded group-hover:bg-accent group-hover:text-black transition"><i class="fa-regular fa-bell"></i> ${asset.alert_price}</div>` : ''}
                        <h3 class="text-2xl font-bold text-white">${asset.ticker} <span class="text-xs bg-accent text-black px-1.5 py-0.5 rounded align-middle">${asset.group}</span></h3>
                        <p class="text-xl font-bold text-white mt-2">$${formatMoney(asset.value)}</p>
                        <p class="text-sm font-bold ${isProfit ? 'text-success' : 'text-danger'}">${sign}$${formatMoney(asset.profit)} (${sign}${asset.profit_pct.toFixed(2)}%)</p>
                    </div>
                `;
                container.innerHTML += card;
            });
        }

        function filterGroup(group) {
            currentGroup = group;
            ['ALL', 'DCA', 'DIV'].forEach(g => {
                const btn = document.getElementById(`tab-${g}`);
                btn.className = g === group ? "px-6 py-2 rounded-full font-semibold border transition bg-accent text-basebg border-accent" : "px-6 py-2 rounded-full text-textsub hover:text-white border border-transparent transition";
            });
            renderAssets();
        }

        function openModal(asset = null) {
            const modal = document.getElementById('asset-modal');
            const btnDelete = document.getElementById('btn-delete');
            
            if(asset) {
                document.getElementById('modal-title').innerText = `แก้ไข: ${asset.ticker}`;
                document.getElementById('inp-ticker').value = asset.ticker;
                document.getElementById('inp-ticker').readOnly = true;
                document.getElementById('inp-shares').value = asset.shares;
                document.getElementById('inp-cost').value = asset.cost;
                document.getElementById('inp-alert').value = asset.alert_price;
                document.getElementById('inp-group').value = asset.group;
                btnDelete.classList.remove('hidden');
            } else {
                document.getElementById('modal-title').innerText = "เพิ่มรายการหุ้น";
                document.getElementById('inp-ticker').value = "";
                document.getElementById('inp-ticker').readOnly = false;
                document.getElementById('inp-shares').value = "";
                document.getElementById('inp-cost').value = "";
                document.getElementById('inp-alert').value = "0";
                document.getElementById('inp-group').value = "Auto";
                btnDelete.classList.add('hidden');
            }
            modal.classList.add('active');
        }

        function closeModal() { document.getElementById('asset-modal').classList.remove('active'); }

        async function saveAsset() {
            const payload = {
                ticker: document.getElementById('inp-ticker').value.toUpperCase(),
                shares: parseFloat(document.getElementById('inp-shares').value) || 0,
                cost: parseFloat(document.getElementById('inp-cost').value) || 0,
                alert_price: parseFloat(document.getElementById('inp-alert').value) || 0,
                group: document.getElementById('inp-group').value
            };
            if(!payload.ticker) return alert('กรุณาใส่ชื่อหุ้น');

            await fetch('http://localhost:8000/api/asset', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload) });
            closeModal(); fetchDashboard();
        }

        async function deleteAsset() {
            const ticker = document.getElementById('inp-ticker').value;
            if(confirm(`ลบ ${ticker} หรือไม่?`)) {
                await fetch(`http://localhost:8000/api/asset/${ticker}`, { method: 'DELETE' });
                closeModal(); fetchDashboard();
            }
        }

        fetchDashboard();
        setInterval(fetchDashboard, 60000);
    </script>
</body>
</html>